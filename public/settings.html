<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sorcery Desktop Settings</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --primary-active: #4338ca;
      --success: #10b981;
      --success-hover: #059669;
      --success-light: #6ee7b7;
      --error: #ef4444;
      --error-hover: #dc2626;
      --error-light: #fca5a5;
      --warning: #f59e0b;
      --warning-light: #fbbf24;
      --bg-primary: #121212;
      --bg-surface: #1e1e1e;
      --bg-elevated: #2d2d2d;
      --text-primary: #f5f5f5;
      --text-secondary: #a0a0a0;
      --text-tertiary: #6b6b6b;
      --border: #333333;
      --border-hover: #444444;
      --shadow: rgba(0, 0, 0, 0.4);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, 'Helvetica Neue', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
    }

    .title-bar {
      height: 35px;
      background: var(--bg-surface);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      -webkit-app-region: drag;
    }

    .title-bar h1 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
      letter-spacing: -0.01em;
    }

    .tabs {
      display: flex;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      padding: 0 1rem;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    .tab {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
      border-bottom: 2px solid transparent;
      position: relative;
      top: 1px;
    }

    .tab:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.05);
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .tab-content {
      flex: 1;
      overflow-y: auto;
      position: relative;
    }

    .tab-pane {
      display: none;
      padding: 1.25rem;
      min-height: 100%;
    }

    .tab-pane.active {
      display: block;
    }

    /* Shared styles */
    .section {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px -1px var(--shadow);
    }

    .section h2 {
      color: var(--text-primary);
      margin-bottom: 0.75rem;
      font-size: 0.875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0.9;
    }

    .button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8125rem;
      font-weight: 600;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
    }

    .button:hover {
      background: var(--primary-hover);
    }

    .button:active {
      background: var(--primary-active);
    }

    .help-text {
      color: var(--text-secondary);
      font-size: 0.75rem;
      margin-top: 0.25rem;
      line-height: 1.4;
    }

    /* Settings tab specific styles */
    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      color: var(--text-primary);
      margin-bottom: 0.375rem;
      font-weight: 500;
      font-size: 0.8125rem;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.875rem;
      font-family: inherit;
      transition: all 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1.25rem;
      padding-right: 2.5rem;
    }

    .workspace-item {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .workspace-item:hover {
      border-color: var(--border-hover);
    }

    .workspace-item.discovered {
      opacity: 0.85;
      border-style: dashed;
    }

    .badge-auto {
      background: #6b7280;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.6875rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-left: 0.5rem;
    }

    .promote-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 0.375rem 0.75rem;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .promote-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .discovered-section-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
      color: var(--text-secondary);
      font-size: 0.8125rem;
    }

    .discovered-section-header .divider {
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .workspace-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .workspace-row .workspace-name {
      flex: 1 1 33%;
      min-width: 0;
    }

    .workspace-row .workspace-path {
      flex: 1;
      min-width: 0;
    }

    .workspace-row select {
      width: 100%;
    }

    .field-label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 0.25rem;
    }

    .field-group {
      display: flex;
      flex-direction: column;
    }

    .field-group.name-field {
      flex: 0 0 33%;
      min-width: 0;
    }

    .field-group.editor-field {
      flex: 1;
      min-width: 0;
    }

    .field-group.path-field {
      flex: 1;
    }

    .add-workspace-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8125rem;
      font-weight: 600;
      margin-top: 0.5rem;
      transition: background 0.15s;
    }

    .add-workspace-btn:hover {
      background: var(--success-hover);
    }

    .remove-btn {
      background: transparent;
      color: var(--error);
      border: 1px solid var(--error);
      width: 28px;
      height: 28px;
      padding: 0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      line-height: 1;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .remove-btn:hover {
      background: var(--error);
      color: white;
    }

    .status-message {
      padding: 0.625rem 0.875rem;
      border-radius: 6px;
      margin-top: 1rem;
      display: none;
      font-weight: 500;
      font-size: 0.8125rem;
    }

    .status-message.success {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid var(--success);
      color: #6ee7b7;
      display: block;
    }

    .status-message.error {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid var(--error);
      color: #fca5a5;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .status-message .status-text {
      flex: 1;
      word-break: break-word;
    }

    .status-message .copy-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: inherit;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.75rem;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .status-message .copy-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .status-message .copy-btn.copied {
      background: rgba(34, 197, 94, 0.3);
      border-color: rgba(34, 197, 94, 0.5);
      color: #86efac;
    }

    .empty-state {
      text-align: center;
      padding: 1.5rem;
      background: rgba(234, 179, 8, 0.1);
      border: 1px solid rgba(234, 179, 8, 0.3);
      border-radius: 6px;
      color: #fbbf24;
      font-size: 0.8125rem;
    }

    /* Testbed specific styles */
    .editor-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 0.75rem;
    }

    .editor-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9rem;
    }

    .editor-card:hover {
      border-color: var(--primary);
      transform: translateY(-1px);
    }

    .editor-card.most-recent {
      border-color: var(--success);
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1);
    }

    .editor-name {
      font-weight: 600;
      color: var(--text-primary);
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .running-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .running-dot.active {
      background: var(--success);
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
      animation: pulse 2s ease-in-out infinite;
    }

    .running-dot.inactive {
      background: var(--border);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }


    .test-button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.4rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .test-button:hover {
      background: var(--primary-hover);
    }

    .test-button:disabled {
      background: var(--bg-elevated);
      color: var(--text-tertiary);
      cursor: not-allowed;
    }

    pre {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
      overflow-x: auto;
      font-size: 0.85rem;
      color: var(--text-primary);
      font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
      line-height: 1.6;
    }

    /* Debug log specific styles */
    .toolbar {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      align-items: center;
    }

    .search-box {
      flex: 1;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      color: var(--text-primary);
      font-size: 0.875rem;
    }

    .filter-button {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 0.5rem 0.875rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .filter-button.active {
      background: var(--bg-elevated);
      color: var(--text-primary);
      border-color: var(--border-hover);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--bg-surface);
      border-radius: 8px;
      overflow: hidden;
    }

    thead {
      background: var(--bg-elevated);
    }

    th {
      text-align: left;
      padding: 0.75rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }

    td {
      padding: 0.75rem;
      border-top: 1px solid var(--border);
      font-size: 0.875rem;
    }

    tr.expandable {
      cursor: pointer;
    }

    tr.expandable:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.5rem;
    }

    .status-dot.success {
      background: var(--success);
    }

    .status-dot.error {
      background: var(--error);
    }

    .code {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      font-size: 0.8125rem;
      background: var(--bg-primary);
      padding: 0.125rem 0.375rem;
      border-radius: 3px;
    }

    .expand-row {
      display: none;
      background: var(--bg-primary);
    }

    .expand-row.visible {
      display: table-row;
    }

    .expand-content {
      padding: 1rem;
    }

    .output-section {
      margin-bottom: 1rem;
    }

    .output-label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .output-text {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      font-size: 0.8125rem;
      background: var(--bg-surface);
      padding: 0.75rem;
      border-radius: 6px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="title-bar" data-tauri-drag-region>
    <h1>Sorcery</h1>
  </div>
  <div class="tabs">
    <button class="tab active" data-tab="settings" onclick="switchTab('settings')">Settings</button>
    <button class="tab" data-tab="workspaces" onclick="switchTab('workspaces')">Workspaces</button>
    <button class="tab" data-tab="testbed" onclick="switchTab('testbed')">Editors</button>
    <button class="tab" data-tab="debug" onclick="switchTab('debug')">Command Log</button>
  </div>

  <div class="tab-content">
    <!-- Settings Tab -->
    <div id="settings-pane" class="tab-pane active">
      <div style="max-width: 1000px; margin: 0 auto;">
        <div id="basic-settings" class="section">
          <div class="form-group">
            <label for="default-editor">Default Editor</label>
            <select id="default-editor">
              <option value="">Loading installed editors...</option>
            </select>
            <p class="help-text">Fallback when no workspace matches</p>
          </div>
          <div class="form-group">
            <label for="preferred-terminal">Terminal for Vim/Neovim</label>
            <select id="preferred-terminal">
              <option value="auto">Auto-detect</option>
              <option value="iterm2">iTerm2</option>
              <option value="alacritty">Alacritty</option>
              <option value="kitty">Kitty</option>
              <option value="wezterm">WezTerm</option>
              <option value="terminal">Terminal.app</option>
              <option value="gnome-terminal">GNOME Terminal</option>
              <option value="konsole">Konsole</option>
              <option value="xterm">Xterm</option>
            </select>
          </div>
          <div class="form-group">
            <label for="default-workspaces-folder">Default Workspaces Folder</label>
            <input type="text" id="default-workspaces-folder" placeholder="~/code" style="font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;">
            <p class="help-text">Git repos here are auto-discovered as workspaces. Clone targets go here too.</p>
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="allow-non-workspace-files" style="width: auto; cursor: pointer;">
              <span>Allow opening files outside of configured workspaces</span>
            </label>
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="auto-switch-clean-branches" style="width: auto; cursor: pointer;" checked>
              <span>Auto-switch branches when working tree is clean</span>
            </label>
          </div>
        </div>

        <div style="margin-top: 1rem;">
          <a href="#" onclick="toggleAdvancedSettings(); return false;" style="color: var(--text-tertiary); font-size: 0.8125rem;" id="advanced-toggle-link">Advanced</a>
        </div>

        <div id="advanced-settings" style="display: none; margin-top: 1rem;">
          <div class="section">
            <h2>Settings File</h2>
            <div style="font-family: monospace; font-size: 0.875rem;">
              <div style="background: var(--bg-elevated); padding: 0.5rem; border-radius: 4px; word-break: break-all;" id="settings-file-path">Loading...</div>
            </div>
          </div>

          <div class="section">
            <h2>Crash Logs</h2>
            <p class="help-text" style="margin-bottom: 0.75rem;">
              System crash reports are stored here. Look for files with "Sorcery" in the name.
            </p>
            <div style="font-family: monospace; font-size: 0.875rem; margin-bottom: 0.75rem;">
              <div style="background: var(--bg-elevated); padding: 0.5rem; border-radius: 4px; word-break: break-all; display: flex; align-items: center; gap: 0.5rem;">
                <span id="logs-directory-path" style="flex: 1;">Loading...</span>
                <a href="#" onclick="openLogsDirectory(); return false;" id="open-logs-link" style="color: var(--primary); white-space: nowrap;">Open Folder</a>
              </div>
            </div>
          </div>

          <div class="section">
            <h2>Protocol Registration</h2>
            <p class="help-text" style="margin-bottom: 1rem;">
              The srcuri:// protocol must be registered with your OS to open links in editors.
            </p>

            <div id="protocol-status-content" style="font-family: monospace; font-size: 0.875rem;">
              <div style="margin-bottom: 0.75rem;">
                <strong style="color: var(--text-secondary);">Status:</strong>
                <span id="protocol-registered" style="font-weight: 600;">Loading...</span>
              </div>
              <div style="margin-bottom: 0.75rem;">
                <strong style="color: var(--text-secondary);">Platform:</strong>
                <span id="protocol-platform">-</span>
              </div>
              <div style="margin-bottom: 0.75rem;">
                <strong style="color: var(--text-secondary);">Current Executable:</strong>
                <div id="protocol-current-exe" style="background: var(--bg-elevated); padding: 0.5rem; border-radius: 4px; margin-top: 0.25rem; word-break: break-all;">-</div>
              </div>
              <div style="margin-bottom: 0.75rem;">
                <strong style="color: var(--text-secondary);">Registered Executable:</strong>
                <div id="protocol-registered-exe" style="background: var(--bg-elevated); padding: 0.5rem; border-radius: 4px; margin-top: 0.25rem; word-break: break-all;">-</div>
              </div>
              <div style="margin-bottom: 0.75rem;">
                <strong style="color: var(--text-secondary);">Executables Match:</strong>
                <span id="protocol-match" style="font-weight: 600;">-</span>
              </div>
              <div style="margin-bottom: 0.75rem;">
                <strong style="color: var(--text-secondary);">Details:</strong>
                <div id="protocol-details" style="background: var(--bg-elevated); padding: 0.5rem; border-radius: 4px; margin-top: 0.25rem; color: var(--text-secondary); font-size: 0.8125rem;">-</div>
              </div>
            </div>

            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
              <button class="button" onclick="loadProtocolStatus()">Refresh Status</button>
              <button class="button" onclick="reregisterProtocol()" id="reregister-btn" style="background: var(--success);">Re-register Protocol</button>
            </div>

            <div id="protocol-status-message" class="status-message">
              <span class="status-text" id="protocol-status-text"></span>
              <button class="copy-btn" id="protocol-copy-btn" onclick="copyProtocolStatus()" style="display: none;">Copy</button>
            </div>
          </div>
        </div>

        <div id="status-message" class="status-message"></div>
      </div>
    </div>

    <!-- Workspaces Tab -->
    <div id="workspaces-pane" class="tab-pane">
      <div style="max-width: 1000px; margin: 0 auto;">
        <div class="section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <h2>Workspace Mappings</h2>
            <button class="add-workspace-btn" onclick="addWorkspace()">+ Add Workspace</button>
          </div>
          <p class="help-text" style="margin-bottom: 0.75rem;">
            Map workspace directories to specific editors. Files will open in the matching editor.
          </p>
          <div id="workspaces-list"></div>
          <div id="discovered-workspaces-section" style="display: none;">
            <div class="discovered-section-header">
              <span class="divider"></span>
              <span>Auto-discovered workspaces</span>
              <span class="divider"></span>
            </div>
            <div id="discovered-workspaces-list"></div>
          </div>
        </div>

        <div id="workspaces-status-message" class="status-message"></div>
      </div>
    </div>

    <!-- Testbed Tab -->
    <div id="testbed-pane" class="tab-pane">
      <div style="max-width: 1200px; margin: 0 auto;">
        <div class="section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div class="help-text">
              <span style="color: var(--success);">●</span> = running | <span style="color: var(--success);">✓</span> = installed
            </div>
            <div style="display: flex; gap: 0.5rem; font-size: 0.875rem;">
              <a href="#" id="filter-installed" onclick="setEditorFilter('installed'); return false;" style="color: var(--text-primary); font-weight: 600;">installed</a>
              <span style="color: var(--text-secondary);">|</span>
              <a href="#" id="filter-all" onclick="setEditorFilter('all'); return false;" style="color: var(--text-secondary);">all</a>
            </div>
          </div>
          <div id="editor-list" class="editor-list">
            <div class="empty-state">Loading editor information...</div>
          </div>
        </div>

        <div style="margin-top: 1rem; font-size: 0.875rem;">
          <span style="color: var(--text-secondary);">Most Recent Editor:</span>
          <span id="most-recent-editor" style="color: var(--success-light); font-weight: 500;">none</span>
        </div>

        <div style="margin-top: 1.5rem;">
          <a href="#" onclick="toggleDebugInfo(); return false;" style="color: var(--text-tertiary); font-size: 0.8125rem;" id="debug-toggle-link">Show debug info</a>
          <div id="debug-info" style="display: none; margin-top: 1rem;">
            <div class="section">
              <h2>Last Seen Data</h2>
              <pre id="last-seen-data">{}</pre>
            </div>
            <div class="section">
              <h2>Current Settings</h2>
              <pre id="settings-content">{}</pre>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Debug Log Tab -->
    <div id="debug-pane" class="tab-pane">
      <div style="max-width: 1200px; margin: 0 auto;">
        <h1 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Command History</h1>
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.875rem;">Log showing the last 30 commands (editor launches, git operations, etc.)</p>

        <div class="toolbar">
          <input type="text" class="search-box" id="search-box" placeholder="Search commands, args, or output...">
          <div style="display: flex; gap: 0.5rem;">
            <button class="filter-button active" data-filter="all" onclick="setFilter('all')">All</button>
            <button class="filter-button" data-filter="success" onclick="setFilter('success')">Success</button>
            <button class="filter-button" data-filter="error" onclick="setFilter('error')">Errors</button>
          </div>
          <button class="button" onclick="loadGitHistory()">Refresh</button>
        </div>

        <div id="table-container">
          <table id="history-table">
            <thead>
              <tr>
                <th style="width: 40px;"></th>
                <th style="width: 80px;">Type</th>
                <th style="width: 130px;">Time</th>
                <th>Command</th>
                <th style="width: 80px;">Exit Code</th>
              </tr>
            </thead>
            <tbody id="history-body">
            </tbody>
          </table>
        </div>

        <div id="empty-state" class="empty-state" style="display: none; background: rgba(16, 185, 129, 0.15); border-color: var(--success); color: var(--success-light);">
          <p>No commands have been executed yet.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');

      document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
      });
      document.getElementById(`${tabName}-pane`).classList.add('active');

      // Load data for the tab
      if (tabName === 'workspaces') {
        syncAndReloadWorkspaces();
      } else if (tabName === 'testbed') {
        loadEditorsTabData();
      } else if (tabName === 'debug') {
        loadGitHistory();
      }
    }

    function toggleAdvancedSettings() {
      const advanced = document.getElementById('advanced-settings');
      const basic = document.getElementById('basic-settings');
      const link = document.getElementById('advanced-toggle-link');
      if (advanced.style.display === 'none') {
        advanced.style.display = 'block';
        basic.style.display = 'none';
        link.textContent = 'Basic';
        loadSettingsPath();
        loadLogsDirectory();
        loadProtocolStatus();
      } else {
        advanced.style.display = 'none';
        basic.style.display = 'block';
        link.textContent = 'Advanced';
      }
    }

    async function loadSettingsPath() {
      try {
        const path = await window.__TAURI__.core.invoke('get_settings_path');
        document.getElementById('settings-file-path').textContent = path;
      } catch (e) {
        document.getElementById('settings-file-path').textContent = 'Error: ' + e;
      }
    }

    async function loadLogsDirectory() {
      try {
        const info = await window.__TAURI__.core.invoke('get_logs_directory');
        document.getElementById('logs-directory-path').textContent = info.path;
        if (!info.exists) {
          document.getElementById('open-logs-link').style.display = 'none';
        }
      } catch (e) {
        document.getElementById('logs-directory-path').textContent = 'Error: ' + e;
      }
    }

    async function openLogsDirectory() {
      try {
        await window.__TAURI__.core.invoke('open_logs_directory');
      } catch (e) {
        showStatus('Failed to open logs directory: ' + e, 'error');
      }
    }

    // Settings Tab
    let workspaces = [];
    let discoveredWorkspaces = [];
    let defaultEditor = 'vscode';
    let allowNonWorkspaceFiles = false;
    let preferredTerminal = 'auto';
    let autoSwitchCleanBranches = true;
    let defaultWorkspacesFolder = '~/code';
    let installedEditors = [];

    async function loadInstalledEditors() {
      try {
        const data = await window.__TAURI__.core.invoke('get_editor_testbed_data');
        installedEditors = data.editors
          .filter(e => e.is_installed)
          .sort((a, b) => a.display_name.localeCompare(b.display_name));
        return installedEditors;
      } catch (e) {
        console.error('Failed to load installed editors:', e);
        return [];
      }
    }

    function populateEditorDropdown(selectElement, selectedValue) {
      selectElement.innerHTML = installedEditors.map(editor =>
        `<option value="${editor.editor_id}" ${selectedValue === editor.editor_id ? 'selected' : ''}>
          ${editor.display_name}
        </option>`
      ).join('');

      if (!installedEditors.find(e => e.editor_id === selectedValue)) {
        selectElement.innerHTML = `<option value="${selectedValue}" selected>${selectedValue} (not installed)</option>` + selectElement.innerHTML;
      }
    }

    async function loadSettings() {
      try {
        await loadInstalledEditors();

        const settings = await window.__TAURI__.core.invoke('get_settings');
        workspaces = settings.workspaces || [];
        defaultEditor = settings.defaults?.editor || 'vscode';
        allowNonWorkspaceFiles = settings.defaults?.allow_non_workspace_files ?? false;
        preferredTerminal = settings.defaults?.preferred_terminal || 'auto';
        autoSwitchCleanBranches = settings.defaults?.auto_switch_clean_branches ?? true;

        // Auto-detect repo folder on first launch (when not yet saved in settings)
        if (!settings.defaults?.default_workspaces_folder) {
          defaultWorkspacesFolder = await window.__TAURI__.core.invoke('detect_source_folder');
          await saveSettings();
        } else {
          defaultWorkspacesFolder = settings.defaults.default_workspaces_folder;
        }

        populateEditorDropdown(document.getElementById('default-editor'), defaultEditor);
        document.getElementById('allow-non-workspace-files').checked = allowNonWorkspaceFiles;
        document.getElementById('preferred-terminal').value = preferredTerminal;
        document.getElementById('auto-switch-clean-branches').checked = autoSwitchCleanBranches;
        document.getElementById('default-workspaces-folder').value = defaultWorkspacesFolder;
        renderWorkspaces();
        await loadDiscoveredWorkspaces();
      } catch (e) {
        showStatus('Error loading settings: ' + e, 'error');
      }
    }

    async function loadDiscoveredWorkspaces() {
      try {
        const allWorkspaces = await window.__TAURI__.core.invoke('get_all_workspaces');
        discoveredWorkspaces = allWorkspaces.discovered || [];
        renderDiscoveredWorkspaces();
      } catch (e) {
        console.error('Failed to load discovered workspaces:', e);
      }
    }

    async function syncAndReloadWorkspaces() {
      try {
        const result = await window.__TAURI__.core.invoke('sync_workspaces');
        if (result.added.length > 0 || result.removed.length > 0) {
          console.log('Workspace sync:', result.added.length, 'added,', result.removed.length, 'removed');
        }
        // Reload settings to get updated workspaces list
        const settings = await window.__TAURI__.core.invoke('get_settings');
        workspaces = settings.workspaces.filter(ws => !ws.auto_discovered) || [];
        renderWorkspaces();
        await loadDiscoveredWorkspaces();
      } catch (e) {
        console.error('Failed to sync workspaces:', e);
      }
    }

    async function saveSettings() {
      const settings = {
        workspaces: workspaces.map(w => ({
          path: w.path,
          editor: w.editor,
          name: w.name || null
        })).filter(w => w.path),
        defaults: {
          editor: defaultEditor,
          allow_non_workspace_files: allowNonWorkspaceFiles,
          preferred_terminal: preferredTerminal,
          auto_switch_clean_branches: autoSwitchCleanBranches,
          default_workspaces_folder: defaultWorkspacesFolder
        }
      };

      try {
        await window.__TAURI__.core.invoke('save_settings', { settings });
        showStatus('Settings saved successfully!', 'success');
      } catch (e) {
        showStatus('Error saving settings: ' + e, 'error');
      }
    }

    async function addWorkspace() {
      try {
        const defaultDir = await window.__TAURI__.core.invoke('detect_source_folder');
        const { open } = window.__TAURI_PLUGIN_DIALOG__;
        const selected = await open({
          directory: true,
          multiple: false,
          title: 'Select Workspace Folder',
          defaultPath: defaultDir
        });

        if (!selected) return;

        const folderName = selected.split('/').pop() || selected.split('\\').pop() || '';
        workspaces.push({
          path: selected,
          editor: '',
          name: folderName
        });
        renderWorkspaces();
        await saveSettings();
      } catch (e) {
        showStatus('Error selecting folder: ' + e, 'error');
      }
    }

    async function removeWorkspace(index) {
      workspaces.splice(index, 1);
      renderWorkspaces();
      await saveSettings();
    }

    async function updateWorkspace(index, field, value) {
      workspaces[index][field] = value;
      if (field === 'editor') {
        await saveSettings();
      }
    }

    async function saveWorkspaceField(index, field, value) {
      workspaces[index][field] = value;
      await saveSettings();
    }

    async function testWorkspace(index) {
      const workspace = workspaces[index];
      if (!workspace.path) {
        showWorkspacesStatus('Please set a workspace path first', 'error');
        return;
      }

      const editorId = workspace.editor || defaultEditor;
      if (!editorId) {
        showWorkspacesStatus('Please select an editor or set a default editor', 'error');
        return;
      }

      try {
        const result = await window.__TAURI__.core.invoke('test_open_file', {
          editorId: editorId,
          testFilePath: workspace.path + '/README.md'
        });
        showWorkspacesStatus(`✓ ${result}`, 'success');
      } catch (err) {
        showWorkspacesStatus(`✗ Test failed: ${err}`, 'error');
      }
    }

    function showWorkspacesStatus(message, type) {
      const el = document.getElementById('workspaces-status-message');
      el.textContent = message;
      el.className = `status-message ${type}`;
      setTimeout(() => { el.className = 'status-message'; }, 5000);
    }

    function renderWorkspaces() {
      const container = document.getElementById('workspaces-list');
      if (workspaces.length === 0) {
        container.innerHTML = '<div class="empty-state">No workspaces configured yet</div>';
        return;
      }

      const items = workspaces.map((ws, idx) => {
        const defaultEditorName = installedEditors.find(e => e.editor_id === defaultEditor)?.display_name || defaultEditor;
        const defaultOption = `<option value="" ${!ws.editor ? 'selected' : ''}>Default (${defaultEditorName})</option>`;
        const editorOptions = installedEditors.map(editor =>
          `<option value="${editor.editor_id}" ${ws.editor === editor.editor_id ? 'selected' : ''}>
            ${editor.display_name}
          </option>`
        ).join('');

        const notInstalledOption = (!installedEditors.find(e => e.editor_id === ws.editor) && ws.editor)
          ? `<option value="${ws.editor}" selected>${ws.editor} (not installed)</option>`
          : '';

        return `
          <div class="workspace-item">
            <div class="workspace-row">
              <div class="field-group name-field">
                <div class="field-label">Name</div>
                <input type="text" placeholder="my-project" value="${ws.name || ''}" oninput="updateWorkspace(${idx}, 'name', this.value)" onblur="saveWorkspaceField(${idx}, 'name', this.value)" />
              </div>
              <div class="field-group editor-field">
                <div class="field-label">Editor</div>
                <select onchange="updateWorkspace(${idx}, 'editor', this.value)">
                  ${defaultOption}${notInstalledOption}${editorOptions}
                </select>
              </div>
              <button class="test-button" onclick="testWorkspace(${idx})" style="align-self: flex-end;">Test</button>
              <button class="remove-btn" onclick="removeWorkspace(${idx})" title="Remove workspace" style="align-self: flex-end;">×</button>
            </div>
            <div class="workspace-row">
              <div class="field-group path-field">
                <div class="field-label">Path</div>
                <input type="text" placeholder="/Users/you/projects/myapp" value="${ws.path || ''}" oninput="updateWorkspace(${idx}, 'path', this.value)" onblur="saveWorkspaceField(${idx}, 'path', this.value)" />
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = items;
    }

    function renderDiscoveredWorkspaces() {
      const section = document.getElementById('discovered-workspaces-section');
      const container = document.getElementById('discovered-workspaces-list');

      if (discoveredWorkspaces.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';

      const defaultEditorName = installedEditors.find(e => e.editor_id === defaultEditor)?.display_name || defaultEditor;

      const items = discoveredWorkspaces.map((ws, idx) => `
        <div class="workspace-item discovered">
          <div class="workspace-row">
            <div class="field-group name-field">
              <div class="field-label">Name <span class="badge-auto">auto</span></div>
              <div style="padding: 0.375rem 0; color: var(--text-primary);">${ws.name}</div>
            </div>
            <div class="field-group editor-field">
              <div class="field-label">Editor</div>
              <div style="padding: 0.375rem 0; color: var(--text-secondary);">${defaultEditorName} (default)</div>
            </div>
            <button class="promote-btn" onclick="promoteWorkspace(${idx})" style="align-self: flex-end;">Add as explicit</button>
            <button class="remove-btn" onclick="deleteDiscoveredWorkspace(${idx})" title="Remove (adds to ignored list)" style="align-self: flex-end;">×</button>
          </div>
          <div class="workspace-row">
            <div class="field-group path-field">
              <div class="field-label">Path</div>
              <div style="padding: 0.375rem 0; color: var(--text-secondary); font-size: 0.875rem;">${ws.path}</div>
            </div>
          </div>
        </div>
      `).join('');

      container.innerHTML = items;
    }

    async function deleteDiscoveredWorkspace(idx) {
      const ws = discoveredWorkspaces[idx];
      if (!ws) return;

      try {
        await window.__TAURI__.core.invoke('delete_workspace', { path: ws.path });
        showWorkspacesStatus('Workspace removed (added to ignored list)', 'success');
        await loadDiscoveredWorkspaces();
      } catch (e) {
        showWorkspacesStatus('Failed to remove workspace: ' + e, 'error');
      }
    }

    async function promoteWorkspace(idx) {
      const ws = discoveredWorkspaces[idx];
      if (!ws) return;

      try {
        await window.__TAURI__.core.invoke('promote_workspace', {
          path: ws.path,
          name: ws.name
        });
        showWorkspacesStatus('Workspace promoted to explicit mapping', 'success');
        // Reload both lists
        await loadSettings();
      } catch (e) {
        showWorkspacesStatus('Failed to promote workspace: ' + e, 'error');
      }
    }

    function showStatus(message, type) {
      const el = document.getElementById('status-message');
      el.textContent = message;
      el.className = `status-message ${type}`;
      setTimeout(() => { el.style.display = 'none'; }, 5000);
    }

    document.getElementById('default-editor').addEventListener('change', async (e) => {
      defaultEditor = e.target.value;
      await saveSettings();
    });

    document.getElementById('allow-non-workspace-files').addEventListener('change', async (e) => {
      allowNonWorkspaceFiles = e.target.checked;
      await saveSettings();
    });

    document.getElementById('preferred-terminal').addEventListener('change', async (e) => {
      preferredTerminal = e.target.value;
      await saveSettings();
    });

    document.getElementById('auto-switch-clean-branches').addEventListener('change', async (e) => {
      autoSwitchCleanBranches = e.target.checked;
      await saveSettings();
    });

    let workspacesFolderSaveTimeout = null;
    document.getElementById('default-workspaces-folder').addEventListener('input', (e) => {
      defaultWorkspacesFolder = e.target.value || '~/code';
      clearTimeout(workspacesFolderSaveTimeout);
      workspacesFolderSaveTimeout = setTimeout(async () => {
        await saveSettings();
        await syncAndReloadWorkspaces();
      }, 500);
    });

    document.getElementById('default-workspaces-folder').addEventListener('keydown', async (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        clearTimeout(workspacesFolderSaveTimeout);
        defaultWorkspacesFolder = e.target.value || '~/code';
        await saveSettings();
        await syncAndReloadWorkspaces();
        e.target.blur();
      }
    });

    // Testbed Tab
    let editorFilter = 'installed';
    let allEditors = [];
    let currentMostRecent = null;

    function setEditorFilter(filter) {
      editorFilter = filter;
      document.getElementById('filter-installed').style.fontWeight = filter === 'installed' ? '600' : 'normal';
      document.getElementById('filter-installed').style.color = filter === 'installed' ? 'var(--text-primary)' : 'var(--text-secondary)';
      document.getElementById('filter-all').style.fontWeight = filter === 'all' ? '600' : 'normal';
      document.getElementById('filter-all').style.color = filter === 'all' ? 'var(--text-primary)' : 'var(--text-secondary)';
      displayEditors(allEditors, currentMostRecent);
    }

    async function loadEditorsTabData() {
      try {
        const data = await window.__TAURI__.core.invoke('get_editor_testbed_data');
        allEditors = data.editors;
        currentMostRecent = data.most_recent;
        displayEditors(data.editors, data.most_recent);
        displayTracking(data.last_seen, data.most_recent);
        displaySettings(data.settings);
      } catch (err) {
        document.getElementById('editor-list').innerHTML =
          `<div class="empty-state">Error loading data: ${err}</div>`;
      }
    }

    function displayEditors(editors, mostRecent) {
      const listEl = document.getElementById('editor-list');
      if (!editors || editors.length === 0) {
        listEl.innerHTML = '<div class="empty-state">No editors found.</div>';
        return;
      }

      let filteredEditors = editors;
      if (editorFilter === 'installed') {
        filteredEditors = editors.filter(e => e.is_installed);
      }

      if (filteredEditors.length === 0) {
        listEl.innerHTML = '<div class="empty-state">No editors match the current filter.</div>';
        return;
      }

      const sortedEditors = [...filteredEditors].sort((a, b) => {
        if (a.is_installed !== b.is_installed) {
          return b.is_installed ? 1 : -1;
        }
        return a.display_name.localeCompare(b.display_name);
      });

      listEl.innerHTML = sortedEditors.map(editor => {
        const statusIcon = editor.is_installed ? '✓' : '✗';
        const statusClass = editor.is_installed ? 'installed' : 'not-installed';
        const runningClass = editor.detected ? 'active' : 'inactive';
        const isMostRecent = editor.editor_id === mostRecent;

        return `
          <div class="editor-card ${isMostRecent ? 'most-recent' : ''}">
            <div class="running-dot ${runningClass}"></div>
            <span class="editor-name">${editor.display_name}</span>
            <span style="color: ${editor.is_installed ? 'var(--success)' : 'var(--error)'}">${statusIcon}</span>
            <button class="test-button" onclick="testEditor('${editor.editor_id}')" ${!editor.is_installed ? 'disabled' : ''}>Test</button>
          </div>
        `;
      }).join('');
    }

    async function testEditor(editorId) {
      try {
        const result = await window.__TAURI__.core.invoke('test_open_file', {
          editorId,
          testFilePath: null
        });
        showTestbedStatus(`✓ ${result}`, 'success');
      } catch (err) {
        showTestbedStatus(`✗ Failed: ${err}`, 'error');
      }
    }

    function showTestbedStatus(message, type) {
      const listEl = document.getElementById('editor-list');
      const statusDiv = document.createElement('div');
      statusDiv.className = 'empty-state';
      statusDiv.style.background = type === 'success' ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)';
      statusDiv.style.borderColor = type === 'success' ? 'var(--success)' : 'var(--error)';
      statusDiv.style.color = type === 'success' ? 'var(--success-light)' : 'var(--error-light)';
      statusDiv.textContent = message;
      listEl.insertBefore(statusDiv, listEl.firstChild);
      setTimeout(() => statusDiv.remove(), 3000);
    }

    function displayTracking(lastSeen, mostRecent) {
      document.getElementById('most-recent-editor').textContent = mostRecent || 'none';
      document.getElementById('last-seen-data').textContent = JSON.stringify(lastSeen, null, 2);
    }

    function toggleDebugInfo() {
      const debugInfo = document.getElementById('debug-info');
      const link = document.getElementById('debug-toggle-link');
      if (debugInfo.style.display === 'none') {
        debugInfo.style.display = 'block';
        link.textContent = 'Hide debug info';
      } else {
        debugInfo.style.display = 'none';
        link.textContent = 'Show debug info';
      }
    }

    function displaySettings(settings) {
      document.getElementById('settings-content').textContent = JSON.stringify(settings, null, 2);
    }

    // Protocol Tab
    async function loadProtocolStatus() {
      try {
        const status = await window.__TAURI__.core.invoke('get_protocol_registration_status');

        const registeredEl = document.getElementById('protocol-registered');
        if (status.is_registered) {
          registeredEl.textContent = 'Registered';
          registeredEl.style.color = 'var(--success-light)';
        } else {
          registeredEl.textContent = 'Not Registered';
          registeredEl.style.color = 'var(--error-light)';
        }

        document.getElementById('protocol-platform').textContent = status.platform;
        document.getElementById('protocol-current-exe').textContent = status.current_executable;
        document.getElementById('protocol-registered-exe').textContent = status.registered_executable || 'N/A';

        const matchEl = document.getElementById('protocol-match');
        if (status.executables_match) {
          matchEl.textContent = 'Yes';
          matchEl.style.color = 'var(--success-light)';
        } else {
          matchEl.textContent = 'No';
          matchEl.style.color = 'var(--warning-light)';
        }

        document.getElementById('protocol-details').textContent = status.details;

        if (!status.executables_match && status.is_registered) {
          showProtocolStatus('Warning: Registered executable does not match current executable. Consider re-registering.', 'error');
        }
      } catch (err) {
        showProtocolStatus('Error loading protocol status: ' + err, 'error');
      }
    }

    async function reregisterProtocol() {
      const btn = document.getElementById('reregister-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Re-registering...';

      try {
        const result = await window.__TAURI__.core.invoke('reregister_protocol');
        showProtocolStatus(result, 'success');

        // Automatically refresh status after re-registration
        await loadProtocolStatus();
      } catch (err) {
        showProtocolStatus('Re-registration failed: ' + err, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    function showProtocolStatus(message, type) {
      const el = document.getElementById('protocol-status-message');
      const textEl = document.getElementById('protocol-status-text');
      const copyBtn = document.getElementById('protocol-copy-btn');

      textEl.textContent = message;
      el.className = `status-message ${type}`;

      if (type === 'error') {
        copyBtn.style.display = 'block';
      } else {
        copyBtn.style.display = 'none';
        setTimeout(() => { el.style.display = 'none'; }, 5000);
      }
    }

    async function copyProtocolStatus() {
      const text = document.getElementById('protocol-status-text').textContent;
      const btn = document.getElementById('protocol-copy-btn');
      try {
        await navigator.clipboard.writeText(text);
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'Copy';
          btn.classList.remove('copied');
        }, 2000);
      } catch (e) {
        console.error('Failed to copy:', e);
      }
    }

    // Debug Log Tab
    let commandHistory = [];
    let currentFilter = 'all';
    let expandedRows = new Set();

    async function loadGitHistory() {
      try {
        commandHistory = await window.__TAURI__.core.invoke('get_git_command_history');
        renderHistory();
      } catch (e) {
        console.error('Failed to load command history:', e);
      }
    }

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
      renderHistory();
    }

    function toggleRow(index) {
      const expandRow = document.getElementById(`expand-${index}`);
      if (expandedRows.has(index)) {
        expandedRows.delete(index);
        expandRow.classList.remove('visible');
      } else {
        expandedRows.add(index);
        expandRow.classList.add('visible');
      }
    }

    function renderHistory() {
      const searchTerm = document.getElementById('search-box').value.toLowerCase();
      let filtered = commandHistory.filter(entry => {
        if (currentFilter === 'success' && !entry.success) return false;
        if (currentFilter === 'error' && entry.success) return false;
        if (searchTerm) {
          const searchableText = `${entry.command} ${entry.args.join(' ')} ${entry.stdout} ${entry.stderr}`.toLowerCase();
          if (!searchableText.includes(searchTerm)) return false;
        }
        return true;
      });

      const tbody = document.getElementById('history-body');
      const emptyState = document.getElementById('empty-state');
      const tableContainer = document.getElementById('table-container');

      if (filtered.length === 0) {
        tableContainer.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      tableContainer.style.display = 'block';
      emptyState.style.display = 'none';

      tbody.innerHTML = filtered.map((entry, index) => {
        const timestamp = new Date(entry.timestamp).toLocaleTimeString();
        const isExpanded = expandedRows.has(index);
        const commandType = entry.command_type || 'git';
        const typeColor = commandType === 'request' ? 'var(--success-light)' :
                         commandType === 'editor' ? 'var(--primary)' : 'var(--warning)';
        const displayCommand = commandType === 'request'
          ? entry.command
          : `${entry.command} ${entry.args.join(' ')}`;
        const displayResult = commandType === 'request' && entry.args.length > 0
          ? `[${entry.args[0]}]`
          : '';
        return `
          <tr class="expandable" onclick="toggleRow(${index})">
            <td><span class="status-dot ${entry.success ? 'success' : 'error'}"></span></td>
            <td><span style="color: ${typeColor}">${commandType}</span></td>
            <td>${timestamp}</td>
            <td><span class="code">${displayCommand}</span> ${displayResult}</td>
            <td>${entry.exit_code !== null ? entry.exit_code : 'N/A'}</td>
          </tr>
          <tr class="expand-row ${isExpanded ? 'visible' : ''}" id="expand-${index}">
            <td colspan="5">
              <div class="expand-content">
                ${commandType !== 'request' ? `
                  <div class="output-section">
                    <div class="output-label">Working Directory</div>
                    <div class="output-text">${entry.working_dir}</div>
                  </div>
                ` : ''}
                ${entry.stdout ? `
                  <div class="output-section">
                    <div class="output-label">${commandType === 'request' ? 'Details' : 'Stdout'}</div>
                    <div class="output-text">${entry.stdout}</div>
                  </div>
                ` : ''}
                ${entry.stderr ? `
                  <div class="output-section">
                    <div class="output-label">${commandType === 'request' ? 'Error' : 'Stderr'}</div>
                    <div class="output-text">${entry.stderr}</div>
                  </div>
                ` : ''}
                ${commandType === 'request' ? `
                  <div class="output-section">
                    <div class="output-label">Duration</div>
                    <div class="output-text">${entry.duration_ms}ms</div>
                  </div>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    document.getElementById('search-box').addEventListener('input', renderHistory);

    // Initialize
    loadSettings();
    loadEditorsTabData();
    setInterval(() => {
      const activeTab = document.querySelector('.tab.active').dataset.tab;
      if (activeTab === 'testbed') {
        loadEditorsTabData();
      } else if (activeTab === 'debug') {
        loadGitHistory();
      }
    }, 5000);
  </script>
</body>
</html>
